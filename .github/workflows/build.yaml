name: Cross-Platform CI

on:
  push:
    branches:
      - master
      - use-format
    tags:
      - "v*" # 例如 v1.0, v2.0, v2.0.1 等
  pull_request:
  workflow_dispatch:

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: |
          sudo apt update
          sudo apt install -y curl gnupg
          curl https://apt.llvm.org/llvm.sh | grep -Ev '^\s*apt(-get)?\s+install' | sudo bash -s 22
          sudo apt-get install -y clang-format-22

      - name: Format check for `src`
        id: check-src
        continue-on-error: true
        run: bash check-format.sh ./src/

      - name: Final result
        id: final
        run: |
          if [ "${{ steps.check-src.outcome }}" == "failure" ]; then
            exit 1
          fi

  format-already-correct:
    name: Format Already Correct
    runs-on: ubuntu-24.04
    needs: format-check
    if: success()
    outputs:
      commit_hash: ${{ steps.get-commit-hash.outputs.commit_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Commit Hash
        id: get-commit-hash
        run: echo "commit_hash=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  format-fix:
    name: Format Fix
    runs-on: ubuntu-24.04
    needs: format-check
    if: failure() && github.event_name == 'push' && github.actor != 'github-actions[bot]'
    permissions:
      contents: write
    outputs:
      commit_hash: ${{ steps.get-commit-hash.outputs.commit_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install clang-format
        run: |
          sudo apt update
          sudo apt install -y curl gnupg
          curl https://apt.llvm.org/llvm.sh | grep -Ev '^\s*apt(-get)?\s+install' | sudo bash -s 22
          sudo apt-get install -y clang-format-22

      - name: Fix format
        run: |
          bash format-all.sh ./src/

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Fix code format issues" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref }}

      - name: Get Commit Hash
        id: get-commit-hash
        run: echo "commit_hash=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  when-format-correct:
    name: When Format Correct
    runs-on: ubuntu-24.04
    needs: ["format-already-correct", "format-fix"]
    if: always()
    outputs:
      commit_hash: ${{ steps.get-commit-hash.outputs.commit_hash }}
    steps:
      - name: Get Commit Hash
        id: get-commit-hash
        run: |
          if [ "${{ needs.format-already-correct.result }}" == "success" ]; then
            echo "commit_hash=${{ needs.format-already-correct.outputs.commit_hash }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ needs.format-fix.result }}" == "success" ]; then
            echo "commit_hash=${{ needs.format-fix.outputs.commit_hash }}" >> "$GITHUB_OUTPUT"
          else
            exit 1
          fi

  build:
    name: Build
    runs-on: ubuntu-24.04
    needs: when-format-correct
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.when-format-correct.outputs.commit_hash }}

      - name: 打印 Commit 信息
        run: git log -1

      - name: 假装我们构建好了
        run: echo "Building..."
